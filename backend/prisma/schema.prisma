// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
  apiKeys  ApiKey[]
}

model ApiKey {
  id        String   @id @default(uuid())
  userId    String
  provider  String // 'openrouter', 'fal_ai'
  apiKey    String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

model Project {
  id        String   @id @default(uuid())
  userId    String
  name      String
  status    String   @default("draft") // draft, processing, completed, error
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  blueprint  Blueprint?
  story      Story?
  characters Character[]
  scenes     Scene[]
  assets     Asset[]
  versions   Version[]
}

model Blueprint {
  id            String   @id @default(uuid())
  projectId     String   @unique
  coreIdea      String   @db.Text
  genre         String
  toneMood      String
  wordCount     Int
  languageStyle String
  narration     String
  sceneCount    Int
  characters    String[] // Array of character names
  customPrompt  String?  @db.Text
  selectedModel String   @default("openrouter/default")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Story {
  id                      String   @id @default(uuid())
  projectId               String   @unique
  title                   String
  storyText               String   @db.Text
  wordCountActual         Int
  constraintsConfirmation String   @db.Text
  scenes                  String[] @db.Text // Array of scene texts
  isValidated             Boolean  @default(false)
  validationErrors        Json?
  selectedModel           String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Character {
  id           String   @id @default(uuid())
  projectId    String
  name         String
  role         String?
  appearance   Json // { eyes, skin, hair }
  outfit       Json // { upper, lower, footwear } - FFCPP format
  props        String[]
  designPrompt String   @db.Text
  snippets     Json // { closeup: {front, side, back}, medium: {...}, wide: {...} }
  isLocked     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
}

model Scene {
  id                  String   @id @default(uuid())
  projectId           String
  sceneIndex          Int
  originalScene       String   @db.Text
  shotType            String? // Wide, Medium, Close-up
  angle               String?
  view                String? // Front, Back, OTS, Profile, Side
  staging             String?  @db.Text
  relationalStaging   String?  @db.Text
  sceneFunction       String?  @db.Text
  backgroundBlueprint Json? // Master location + overlays
  isLocked            Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assets  Asset[]

  @@unique([projectId, sceneIndex])
}

model Asset {
  id         String   @id @default(uuid())
  projectId  String
  sceneId    String?
  type       String // 'image', 'audio', 'video'
  url        String
  storageKey String // S3 key or storage reference
  prompt     String?  @db.Text
  modelUsed  String
  metadata   Json? // seed, resolution, style, etc.
  isLocked   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scene   Scene?  @relation(fields: [sceneId], references: [id], onDelete: Cascade)
}

model Version {
  id          String   @id @default(uuid())
  projectId   String
  versionData Json // Snapshot of entire project state
  description String?
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}
